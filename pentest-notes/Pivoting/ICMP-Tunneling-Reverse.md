# ICMP Tunneling Reverse
ICMP tunneling encapsulates your traffic within `ICMP packets` containing `echo requests` and `responses`. ICMP tunneling would only work when ping responses are permitted within a firewalled network.

## [ptunnel-ng](https://github.com/utoni/ptunnel-ng)

For building on older glibc, see attached note

```sh
# Grab it
git clone https://github.com/utoni/ptunnel-ng.git

# Build with autogen.sh
sudo ./autogen.sh

# Static binary
sudo apt install automake autoconf -y
cd ptunnel-ng/
sed -i '$s/.*/LDFLAGS=-static "${NEW_WD}\/configure" --enable-static $@ \&\& make clean \&\& make -j${BUILDJOBS:-4} all/' autogen.sh
./autogen.sh

# Send dir or binary
scp -r ptunnel-ng ubuntu@10.129.202.64:~/
```

### Starting the ptunnel-ng Server on the Target Host

```sh
# -r should be the jump host
ubuntu@WEB01:~/ptunnel-ng/src$ sudo ./ptunnel-ng -r10.129.202.64 -R22
```

Be ensure this happens through local port 2222 (`-l2222`), to send traffic through ICMP.

```sh
# Client on Attack Host
sudo ./ptunnel-ng -p10.129.202.64 -l2222 -r10.129.202.64 -R22

# Connect
ssh -p2222 -lubuntu 127.0.0.1
```

### Enable Dynamic P/F over SSH

```sh
ssh -D 9050 -p2222 -lubuntu 127.0.0.1

# Proxychains
proxychains nmap -sV -sT 172.16.5.19 -p3389
```

# * ptunnel-ng build glibc 2.31
## Build in a container that uses glibc 2.31 (Ubuntu 20.04 / Debian 11)

This produces a binary that will be compatible with targets using glibc 2.31 and older OpenSSL (avoids `libcrypto.so.3` errors).

```sh
mkdir -p ~/ptunnel_build/out
docker run --rm -it -v ~/ptunnel_build:/workdir -w /workdir ubuntu:20.04 /bin/bash -lc "\
  apt-get update && apt-get install -y build-essential autoconf automake libtool pkg-config git \
    libpcap-dev libssl-dev libselinux1-dev ca-certificates && \
  git clone https://github.com/utoni/ptunnel-ng.git && \
  cd ptunnel-ng && \
  ./autogen.sh && ./configure --prefix=/usr && make -j\$(nproc) && \
  cp src/ptunnel-ng /workdir/out/ && \
  echo BUILD_DONE"
```

*   Uses `ubuntu:20.04` (glibc 2.31).
*   Installs dev packages including `libssl-dev` that match OpenSSL 1.1 (so the produced binary will link to `libcrypto.so.1.1`, not `libcrypto.so.3`).
*   Runs `autogen.sh` / `configure` / `make`.
*   Copies the binary to `~/ptunnel_build/out/ptunnel-ng`

## If you prefer a Dockerfile

Save this as `Dockerfile.build` and build it:

```sh
FROM ubuntu:20.04
ENV DEBIAN_FRONTEND=noninteractive
RUN apt-get update && apt-get install -y \
    build-essential autoconf automake libtool pkg-config git \
    libpcap-dev libssl-dev libselinux1-dev ca-certificates \
  && rm -rf /var/lib/apt/lists/*
WORKDIR /build
RUN git clone https://github.com/utoni/ptunnel-ng.git
WORKDIR /build/ptunnel-ng
RUN ./autogen.sh && ./configure --prefix=/usr && make -j$(nproc)
# final binary available at /build/ptunnel-ng/src/ptunnel-ng
```

Build & export:

```sh
docker build -t ptunnel-build -f Dockerfile.build .
docker run --rm -v $(pwd)/out:/out ptunnel-build /bin/bash -lc "cp /build/ptunnel-ng/src/ptunnel-ng /out/"
```